<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SAP ECC 6.0 — Solix Intelligent Data Access</title>
<style>
  :root {
    --bg: #0f1117;
    --surface: #1a1d27;
    --surface2: #242736;
    --border: #2e3144;
    --text: #e4e4e7;
    --text-dim: #9294a0;
    --accent: #6366f1;
    --accent-hover: #818cf8;
    --green: #22c55e;
    --orange: #f59e0b;
    --red: #ef4444;
    --sql-bg: #1e2030;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }

  /* Header */
  header {
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    padding: 16px 24px;
    display: flex;
    align-items: center;
    gap: 16px;
  }
  .header-logo {
    height: 28px;
    width: auto;
    flex-shrink: 0;
  }
  header h1 { font-size: 18px; font-weight: 600; }
  header .subtitle { color: var(--text-dim); font-size: 13px; margin-left: auto; display: flex; align-items: center; gap: 10px; }
  .status-dot {
    width: 8px; height: 8px; border-radius: 50%;
    display: inline-block; margin-right: 6px;
  }
  .status-dot.connected { background: var(--green); }
  .status-dot.disconnected { background: var(--orange); }
  .settings-btn {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text-dim);
    padding: 6px 10px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.15s;
  }
  .settings-btn:hover { border-color: var(--accent); color: var(--accent); }

  /* Session token tracker */
  .session-tokens {
    position: relative;
    display: inline-flex;
    align-items: center;
  }
  .session-tokens-btn {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text-dim);
    padding: 4px 10px;
    cursor: pointer;
    font-size: 11px;
    font-family: 'SF Mono', 'Fira Code', monospace;
    transition: all 0.15s;
    white-space: nowrap;
  }
  .session-tokens-btn:hover { border-color: var(--accent); color: var(--accent); }
  .session-tokens-detail {
    display: none;
    position: absolute;
    top: calc(100% + 8px);
    right: 0;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px 16px;
    font-size: 12px;
    color: var(--text-dim);
    min-width: 220px;
    z-index: 100;
    box-shadow: 0 8px 24px rgba(0,0,0,0.4);
  }
  .session-tokens-detail.visible { display: block; }
  .session-tokens-detail h4 { margin: 0 0 8px; font-size: 12px; color: var(--text-main); font-weight: 600; }
  .session-tokens-row { display: flex; justify-content: space-between; padding: 3px 0; }
  .session-tokens-row .label { color: var(--text-dim); }
  .session-tokens-row .value { color: var(--accent); font-family: 'SF Mono', monospace; font-size: 11px; }
  .session-tokens-row.total { border-top: 1px solid var(--border); margin-top: 4px; padding-top: 6px; }
  .session-tokens-row.total .label { color: var(--text-main); font-weight: 600; }
  .session-tokens-row.queries .value { color: var(--text-dim); }

  .sidebar-toggle-btn {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    background: transparent;
    border: none;
    color: var(--text-dim);
    padding: 4px 8px;
    cursor: pointer;
    font-size: 11px;
    font-family: inherit;
    transition: color 0.15s;
    white-space: nowrap;
    opacity: 0.6;
  }
  .sidebar-toggle-btn:hover { color: var(--accent); opacity: 1; }
  .sidebar-toggle-icon { font-size: 11px; line-height: 1; }
  .sidebar-toggle-label { font-size: 11px; font-weight: 400; }

  /* Main layout */
  .main { flex: 1; display: flex; max-height: calc(100vh - 69px); }

  /* Sidebar */
  .sidebar {
    width: 280px;
    background: var(--surface);
    border-right: 1px solid var(--border);
    padding: 16px;
    overflow-y: auto;
    flex-shrink: 0;
    transition: width 0.25s ease, padding 0.25s ease, opacity 0.2s ease;
  }
  .sidebar.collapsed {
    width: 0;
    padding: 0;
    overflow: hidden;
    opacity: 0;
    border-right: none;
  }
  .sidebar h3 {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-dim);
    margin-bottom: 12px;
  }
  .example-btn {
    display: block;
    width: 100%;
    text-align: left;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 10px 12px;
    color: var(--text);
    font-size: 13px;
    line-height: 1.4;
    cursor: pointer;
    margin-bottom: 8px;
    transition: all 0.15s;
  }
  .example-btn:hover {
    border-color: var(--accent);
    background: rgba(99, 102, 241, 0.08);
  }
  .sidebar .section { margin-bottom: 24px; }

  /* Chat area */
  .chat-area { flex: 1; display: flex; flex-direction: column; min-width: 0; }
  .messages { flex: 1; overflow-y: auto; padding: 24px; }
  .message { margin: 0 0 20px; }
  .message.user { max-width: 860px; }
  .message .label {
    font-size: 12px; font-weight: 600;
    text-transform: uppercase; letter-spacing: 0.3px; margin-bottom: 6px;
  }
  .message.user .label { color: var(--accent); }
  .message.assistant .label { color: var(--green); }
  .message .content {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 16px 20px;
    font-size: 14px;
    line-height: 1.6;
  }
  .message.user .content {
    background: rgba(99, 102, 241, 0.06);
    border-color: rgba(99, 102, 241, 0.2);
  }

  /* Results table */
  .results-container {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    overflow: hidden;
    margin-bottom: 4px;
  }
  .results-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 10px 16px;
    background: rgba(34, 197, 94, 0.08);
    border-bottom: 1px solid var(--border);
    font-size: 13px; color: var(--text-dim);
  }
  .results-header .row-count { color: var(--green); font-weight: 600; }
  .results-table-wrap {
    overflow-x: auto;
    max-height: 60vh;
    overflow-y: auto;
  }
  .results-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 12px;
    font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
  }
  .results-table th {
    background: var(--surface2);
    color: var(--accent);
    text-align: left;
    padding: 8px 12px;
    border-bottom: 2px solid var(--border);
    position: sticky;
    top: 0;
    z-index: 1;
    font-weight: 600;
    white-space: nowrap;
  }
  .results-table td {
    padding: 6px 12px;
    border-bottom: 1px solid rgba(46, 49, 68, 0.5);
    color: var(--text);
    white-space: nowrap;
  }
  .results-table tr:hover td { background: rgba(99, 102, 241, 0.04); }
  .results-table tr:nth-child(even) td { background: rgba(255,255,255,0.01); }
  .cell-currency { color: #22c55e; font-variant-numeric: tabular-nums; }
  .cell-number { font-variant-numeric: tabular-nums; }
  .results-error {
    padding: 14px 16px;
    color: var(--orange);
    font-size: 13px;
    font-family: 'SF Mono', monospace;
    white-space: pre-wrap;
  }
  .results-none {
    padding: 20px 16px;
    color: var(--text-dim);
    font-size: 13px;
    text-align: center;
  }

  /* Show SQL toggle */
  .sql-toggle {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    background: transparent;
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text-dim);
    font-size: 12px;
    padding: 5px 12px;
    cursor: pointer;
    transition: all 0.15s;
    margin-top: 10px;
  }
  .sql-toggle:hover { border-color: var(--accent); color: var(--accent); }
  .sql-toggle .arrow { transition: transform 0.2s; display: inline-block; }
  .sql-toggle.open .arrow { transform: rotate(90deg); }

  /* SQL detail section (hidden by default) */
  .sql-detail {
    display: none;
    margin-top: 8px;
  }
  .sql-detail.visible { display: block; }

  .sql-block {
    background: var(--sql-bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    margin: 8px 0;
    overflow: hidden;
  }
  .sql-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 8px 14px;
    background: rgba(99, 102, 241, 0.08);
    border-bottom: 1px solid var(--border);
    font-size: 12px; color: var(--text-dim);
  }
  .copy-btn {
    background: transparent;
    border: 1px solid var(--border);
    border-radius: 4px;
    color: var(--text-dim);
    font-size: 11px;
    padding: 3px 8px;
    cursor: pointer;
    transition: all 0.15s;
  }
  .copy-btn:hover { border-color: var(--accent); color: var(--accent); }
  .copy-btn.copied { border-color: var(--green); color: var(--green); }
  .sql-code {
    padding: 14px;
    overflow-x: auto;
    font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
    font-size: 13px; line-height: 1.5;
    white-space: pre; color: #c9d1d9;
  }

  /* Explanation text inside SQL detail */
  .explanation { margin-bottom: 8px; font-size: 13px; color: var(--text-dim); line-height: 1.5; }
  .explanation p { margin: 6px 0; }
  .explanation ul, .explanation ol { margin: 4px 0 4px 20px; padding: 0; }
  .explanation li { margin: 2px 0; }
  .explanation strong { color: var(--text-main); }
  .explanation code { background: rgba(255,255,255,0.08); padding: 1px 5px; border-radius: 3px; font-size: 0.9em; }

  /* SQLite translation detail */
  .sqlite-detail {
    padding: 6px 14px 10px;
    font-size: 11px;
    color: var(--text-dim);
  }
  .sqlite-detail summary { cursor: pointer; }
  .sqlite-detail pre {
    margin-top: 6px;
    font-family: 'SF Mono', monospace;
    font-size: 11px;
    white-space: pre-wrap;
    color: #888;
  }

  /* Token usage */
  .token-usage {
    margin-top: 10px;
    padding: 8px 14px;
    font-size: 12px;
    color: var(--text-dim);
    border-top: 1px solid rgba(255,255,255,0.06);
  }
  .token-label { font-weight: 600; color: var(--text-main); }
  .token-value { color: var(--accent); }

  /* Input area */
  .input-area {
    padding: 16px 24px;
    background: var(--surface);
    border-top: 1px solid var(--border);
  }
  .input-row { max-width: 860px; margin: 0 auto; display: flex; gap: 10px; }
  .input-row textarea {
    flex: 1;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    color: var(--text);
    font-size: 14px;
    font-family: inherit;
    padding: 12px 16px;
    resize: none;
    outline: none;
    min-height: 48px;
    max-height: 120px;
    transition: border-color 0.15s;
  }
  .input-row textarea:focus { border-color: var(--accent); }
  .input-row textarea::placeholder { color: var(--text-dim); }
  .send-btn {
    width: 48px; height: 48px;
    background: var(--accent);
    border: none; border-radius: 10px;
    color: white; font-size: 18px;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: background 0.15s;
    flex-shrink: 0; align-self: flex-end;
  }
  .send-btn:hover { background: var(--accent-hover); }
  .send-btn:disabled { opacity: 0.5; cursor: not-allowed; }

  /* Loading animation */
  .loading { display: flex; gap: 4px; padding: 8px 0; }
  .loading span {
    width: 6px; height: 6px; border-radius: 50%;
    background: var(--accent);
    animation: bounce 1.4s infinite ease-in-out;
  }
  .loading span:nth-child(1) { animation-delay: -0.32s; }
  .loading span:nth-child(2) { animation-delay: -0.16s; }
  @keyframes bounce {
    0%, 80%, 100% { transform: scale(0); opacity: 0.3; }
    40% { transform: scale(1); opacity: 1; }
  }

  /* Welcome screen */
  .welcome { max-width: 600px; margin: 60px auto; text-align: center; padding: 0 24px; }
  .welcome h2 { font-size: 22px; margin-bottom: 8px; }
  .welcome p { color: var(--text-dim); font-size: 14px; line-height: 1.6; margin-bottom: 20px; }
  .welcome .modules { display: flex; gap: 12px; justify-content: center; margin-bottom: 24px; }
  .module-badge {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 6px 14px;
    font-size: 13px; color: var(--text-dim);
  }

  /* Setup banner */
  .setup-banner {
    background: rgba(245, 158, 11, 0.08);
    border: 1px solid rgba(245, 158, 11, 0.3);
    border-radius: 10px;
    padding: 20px 24px;
    max-width: 600px;
    margin: 24px auto 0;
    text-align: left;
  }
  .setup-banner h3 { font-size: 15px; color: var(--orange); margin-bottom: 8px; }
  .setup-banner p { font-size: 13px; color: var(--text-dim); line-height: 1.5; margin-bottom: 12px; }
  .setup-banner ol { font-size: 13px; color: var(--text-dim); line-height: 1.8; padding-left: 20px; margin-bottom: 14px; }
  .setup-banner a { color: var(--accent); text-decoration: none; }
  .setup-banner a:hover { text-decoration: underline; }
  .key-input-row { display: flex; gap: 8px; }
  .key-input {
    flex: 1;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-family: 'SF Mono', monospace;
    font-size: 13px;
    padding: 10px 14px;
    outline: none;
  }
  .key-input:focus { border-color: var(--accent); }
  .key-input::placeholder { color: var(--text-dim); font-family: inherit; }
  .key-save-btn {
    background: var(--accent);
    border: none;
    border-radius: 8px;
    color: white;
    font-size: 13px;
    font-weight: 600;
    padding: 10px 20px;
    cursor: pointer;
    transition: background 0.15s;
    white-space: nowrap;
  }
  .key-save-btn:hover { background: var(--accent-hover); }
  .key-save-btn:disabled { opacity: 0.6; cursor: not-allowed; }
  .key-status { font-size: 12px; margin-top: 8px; }
  .key-status.error { color: var(--red); }
  .key-status.success { color: var(--green); }

  /* Modal overlay */
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    z-index: 100;
    align-items: center;
    justify-content: center;
  }
  .modal-overlay.active { display: flex; }
  .modal {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 28px;
    width: 480px;
    max-width: 90vw;
  }
  .modal h2 { font-size: 17px; margin-bottom: 16px; }
  .modal label { font-size: 13px; color: var(--text-dim); display: block; margin-bottom: 6px; }
  .modal .current-key {
    font-size: 13px;
    color: var(--green);
    background: rgba(34, 197, 94, 0.08);
    border: 1px solid rgba(34, 197, 94, 0.2);
    border-radius: 6px;
    padding: 8px 12px;
    margin-bottom: 14px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .remove-key-btn {
    background: transparent;
    border: 1px solid var(--red);
    border-radius: 4px;
    color: var(--red);
    font-size: 11px;
    padding: 3px 8px;
    cursor: pointer;
  }
  .modal-close {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-size: 13px;
    padding: 8px 20px;
    cursor: pointer;
    margin-top: 16px;
  }

  /* Syntax highlighting */
  .kw { color: #c678dd; }
  .fn { color: #61afef; }
  .str { color: #98c379; }
  .num { color: #d19a66; }
  .cm { color: #5c6370; font-style: italic; }

  /* Responsive */
  @media (max-width: 768px) {
    .sidebar { display: none; }
    .sidebar-toggle-btn { display: none; }
    .messages { padding: 16px; }
    .input-area { padding: 12px 16px; }
  }
</style>
</head>
<body>

<header>
  <button class="sidebar-toggle-btn" id="sidebarToggle" onclick="toggleSidebar()" title="Toggle examples panel">
    <span class="sidebar-toggle-icon" id="sidebarToggleIcon">&#9664;</span>
    <span class="sidebar-toggle-label">Examples</span>
  </button>
  <img class="header-logo" src="https://bec49d6c.delivery.rocketcdn.me/wp-content/themes/vantage-child/images/solix-logo-white.svg" alt="Solix Technologies">
  <h1>SAP ECC 6.0 Intelligent Data Access</h1>
  <div class="subtitle">
    <span>
      <span class="status-dot" id="statusDot"></span>
      <span id="statusText">Connecting...</span>
    </span>
    <span id="testDbIndicator" style="display:none; font-size:12px; color:var(--green); margin-right:4px;"></span>
    <div class="session-tokens" id="sessionTokensContainer">
      <button class="session-tokens-btn" id="sessionTokensBtn" onclick="toggleSessionTokens()" title="Session token usage">0 tokens</button>
      <div class="session-tokens-detail" id="sessionTokensDetail">
        <h4>Session Token Usage</h4>
        <div class="session-tokens-row queries">
          <span class="label">Queries</span>
          <span class="value" id="stQueries">0</span>
        </div>
        <div class="session-tokens-row">
          <span class="label">Input tokens</span>
          <span class="value" id="stInput">0</span>
        </div>
        <div class="session-tokens-row">
          <span class="label">Output tokens</span>
          <span class="value" id="stOutput">0</span>
        </div>
        <div class="session-tokens-row total">
          <span class="label">Total tokens</span>
          <span class="value" id="stTotal">0</span>
        </div>
        <div class="session-tokens-row total">
          <span class="label">Est. cost</span>
          <span class="value" id="stCost">$0.00</span>
        </div>
      </div>
    </div>
    <button class="settings-btn" onclick="openSettings()" title="API Key Settings">&#9881;</button>
  </div>
</header>

<div class="main">
  <aside class="sidebar" id="sidebar">
    <div class="section">
      <h3>Example Questions</h3>

      <p style="color:#888;font-size:11px;margin:0 0 6px;">FI-AP &mdash; Accounts Payable</p>
      <button class="example-btn" onclick="askExample(this)">Who are our top 10 vendors by total spend?</button>
      <button class="example-btn" onclick="askExample(this)">Show me unpaid vendor invoices for Acme Corp</button>
      <button class="example-btn" onclick="askExample(this)">Show vendor line items for company 1000 (FBL1N)</button>
      <button class="example-btn" onclick="askExample(this)">Display vendor master details (FK03)</button>

      <p style="color:#888;font-size:11px;margin:12px 0 6px;">FI-AR &mdash; Accounts Receivable</p>
      <button class="example-btn" onclick="askExample(this)">Show me customer open items by aging bucket</button>
      <button class="example-btn" onclick="askExample(this)">Show customer line items with payment status (FBL5N)</button>
      <button class="example-btn" onclick="askExample(this)">Display customer master with contact details (XD03)</button>

      <p style="color:#888;font-size:11px;margin:12px 0 6px;">FI-GL &mdash; General Ledger</p>
      <button class="example-btn" onclick="askExample(this)">What is the GL trial balance for company 1000?</button>
      <button class="example-btn" onclick="askExample(this)">What journal entries posted to account 400000?</button>
      <button class="example-btn" onclick="askExample(this)">Show me the trial balance for fiscal year 2025</button>
      <button class="example-btn" onclick="askExample(this)">Display accounting document 5100000001 (FB03)</button>
      <button class="example-btn" onclick="askExample(this)">Show GL line items for account 400000 (FBL3N)</button>

      <p style="color:#888;font-size:11px;margin:12px 0 6px;">CO &mdash; Controlling</p>
      <button class="example-btn" onclick="askExample(this)">Show me cost center actual vs plan for 2025</button>
      <button class="example-btn" onclick="askExample(this)">List cost center line items for cost center 1000 (KSB1)</button>
      <button class="example-btn" onclick="askExample(this)">What are the internal orders and their costs? (KOB1)</button>

      <p style="color:#888;font-size:11px;margin:12px 0 6px;">MM &mdash; Materials Management</p>
      <button class="example-btn" onclick="askExample(this)">Show me all POs over $50,000</button>
      <button class="example-btn" onclick="askExample(this)">Display purchase order details with GR history (ME23N)</button>
      <button class="example-btn" onclick="askExample(this)">Show material document list for plant 1000 (MB51)</button>
      <button class="example-btn" onclick="askExample(this)">What are the open purchase requisitions? (ME5A)</button>

      <p style="color:#888;font-size:11px;margin:12px 0 6px;">SD &mdash; Sales & Distribution</p>
      <button class="example-btn" onclick="askExample(this)">What sales orders were created in Q1 2025?</button>
      <button class="example-btn" onclick="askExample(this)">Display sales order details with items (VA03)</button>
      <button class="example-btn" onclick="askExample(this)">Show billing documents for this month (VF03)</button>
      <button class="example-btn" onclick="askExample(this)">What deliveries are pending shipment? (VL03)</button>

      <p style="color:#888;font-size:11px;margin:12px 0 6px;">PM &mdash; Plant Maintenance</p>
      <button class="example-btn" onclick="askExample(this)">Show all maintenance orders and their status (IW33)</button>
      <button class="example-btn" onclick="askExample(this)">List equipment with functional locations (IE03)</button>
      <button class="example-btn" onclick="askExample(this)">What maintenance plans are scheduled? (IP03)</button>
      <button class="example-btn" onclick="askExample(this)">Show quality inspection lots and results (QA03)</button>

      <p style="color:#888;font-size:11px;margin:12px 0 6px;">HR &mdash; Human Resources</p>
      <button class="example-btn" onclick="askExample(this)">List all employees with their positions</button>
      <button class="example-btn" onclick="askExample(this)">Show employee personal data with addresses (PA20)</button>
      <button class="example-btn" onclick="askExample(this)">What is the headcount by organizational unit?</button>

      <p style="color:#888;font-size:11px;margin:12px 0 6px;">PAY &mdash; Payroll</p>
      <button class="example-btn" onclick="askExample(this)">Show payroll results for all employees</button>
      <button class="example-btn" onclick="askExample(this)">What are the wage type totals by cost center?</button>

      <p style="color:#888;font-size:11px;margin:12px 0 6px;">BEN &mdash; Benefits</p>
      <button class="example-btn" onclick="askExample(this)">Show employees enrolled in health plans</button>
      <button class="example-btn" onclick="askExample(this)">What are the savings plan contribution rates?</button>
    </div>
    <div class="section">
      <h3>Modules Loaded</h3>
      <div class="module-badge">FI-GL &mdash; General Ledger</div>
      <div class="module-badge" style="margin-top:8px;">FI-AP &mdash; Accounts Payable</div>
      <div class="module-badge" style="margin-top:8px;">FI-AR &mdash; Accounts Receivable</div>
      <div class="module-badge" style="margin-top:8px;">CO &mdash; Controlling</div>
      <div class="module-badge" style="margin-top:8px;">MM &mdash; Materials Management</div>
      <div class="module-badge" style="margin-top:8px;">SD &mdash; Sales & Distribution</div>
      <div class="module-badge" style="margin-top:8px;">PM &mdash; Plant Maintenance</div>
      <div class="module-badge" style="margin-top:8px;">HR &mdash; Human Resources</div>
      <div class="module-badge" style="margin-top:8px;">PAY &mdash; Payroll</div>
      <div class="module-badge" style="margin-top:8px;">BEN &mdash; Benefits</div>
    </div>
  </aside>

  <div class="chat-area">
    <div class="messages" id="messages">
      <div class="welcome" id="welcome">
        <h2>Ask a business question</h2>
        <p>Type a question in plain English about your SAP ECC data and get answers back instantly.</p>
        <div class="modules" style="flex-wrap:wrap;">
          <div class="module-badge">FI-GL</div>
          <div class="module-badge">FI-AP</div>
          <div class="module-badge">FI-AR</div>
          <div class="module-badge">CO</div>
          <div class="module-badge">MM</div>
          <div class="module-badge">SD</div>
          <div class="module-badge">PM</div>
          <div class="module-badge">HR</div>
          <div class="module-badge">PAY</div>
          <div class="module-badge">BEN</div>
        </div>
        <p style="font-size:13px;">Try clicking an example from the sidebar, or type your own question below.</p>

        <!-- Setup banner (shown when no API key) -->
        <div class="setup-banner" id="setupBanner" style="display:none;">
          <h3>&#128273; API Key Required</h3>
          <p>To generate SQL automatically, you need an Anthropic API key. Here's how to get one:</p>
          <ol>
            <li>Go to <a href="https://console.anthropic.com" target="_blank">console.anthropic.com</a> and sign up or log in</li>
            <li>Navigate to <strong>API Keys</strong> in settings</li>
            <li>Click <strong>Create Key</strong>, copy it (starts with <code>sk-ant-</code>)</li>
            <li>Paste it below:</li>
          </ol>
          <div class="key-input-row">
            <input type="password" class="key-input" id="setupKeyInput"
              placeholder="sk-ant-api03-..." autocomplete="off"
              onkeydown="if(event.key==='Enter')saveKeyFromSetup()">
            <button class="key-save-btn" id="setupSaveBtn" onclick="saveKeyFromSetup()">Connect</button>
          </div>
          <div class="key-status" id="setupKeyStatus"></div>
        </div>
      </div>
    </div>

    <div class="input-area">
      <div class="input-row">
        <textarea id="questionInput" rows="1" placeholder="e.g., Show me unpaid vendor invoices in company code 1000..."
          onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendQuestion()}"
          oninput="autoResize(this)"></textarea>
        <button class="send-btn" id="sendBtn" onclick="sendQuestion()">&#8594;</button>
      </div>
    </div>
  </div>
</div>

<!-- Settings Modal -->
<div class="modal-overlay" id="settingsModal">
  <div class="modal">
    <h2>&#9881; Settings</h2>

    <label>Anthropic API Key</label>
    <div class="current-key" id="currentKeyDisplay" style="display:none;">
      <span>&#9989; Connected: <span id="currentKeyPreview"></span></span>
      <button class="remove-key-btn" onclick="removeKey()">Remove</button>
    </div>

    <div id="settingsKeyForm">
      <div class="key-input-row">
        <input type="password" class="key-input" id="settingsKeyInput"
          placeholder="sk-ant-api03-..." autocomplete="off"
          onkeydown="if(event.key==='Enter')saveKeyFromSettings()">
        <button class="key-save-btn" id="settingsSaveBtn" onclick="saveKeyFromSettings()">Save</button>
      </div>
      <div class="key-status" id="settingsKeyStatus"></div>
    </div>

    <label style="margin-top:16px;">Model</label>
    <div style="font-size:13px; color:var(--text-dim); margin-bottom:4px;" id="modelDisplay">Loading...</div>

    <button class="modal-close" onclick="closeSettings()">Close</button>
  </div>
</div>

<script>
const API_BASE = window.location.origin;
let isGenerating = false;
let appState = { has_api: false, model: '', key_preview: '', has_test_db: false };
let conversationHistory = [];  // Tracks message history for multi-turn conversations

// Session token tracking
let sessionTokens = { input: 0, output: 0, queries: 0 };

// Token cost calculation (Claude Sonnet 4.5: $3/M input, $15/M output)
function calcTokenCost(inputTokens, outputTokens) {
  return (inputTokens / 1000000) * 3.0 + (outputTokens / 1000000) * 15.0;
}
function formatCost(cost) {
  return cost < 0.01 ? '$' + cost.toFixed(4) : '$' + cost.toFixed(2);
}

function updateSessionTokens(usage) {
  if (!usage) return;
  sessionTokens.input += usage.input_tokens || 0;
  sessionTokens.output += usage.output_tokens || 0;
  sessionTokens.queries++;
  const total = sessionTokens.input + sessionTokens.output;
  const cost = calcTokenCost(sessionTokens.input, sessionTokens.output);
  document.getElementById('sessionTokensBtn').textContent = total.toLocaleString() + ' tokens (' + formatCost(cost) + ')';
  document.getElementById('stQueries').textContent = sessionTokens.queries.toLocaleString();
  document.getElementById('stInput').textContent = sessionTokens.input.toLocaleString();
  document.getElementById('stOutput').textContent = sessionTokens.output.toLocaleString();
  document.getElementById('stTotal').textContent = total.toLocaleString();
  document.getElementById('stCost').textContent = formatCost(cost);
}

function toggleSessionTokens() {
  const detail = document.getElementById('sessionTokensDetail');
  detail.classList.toggle('visible');
}

// Close session token popup when clicking outside
document.addEventListener('click', function(e) {
  const container = document.getElementById('sessionTokensContainer');
  if (container && !container.contains(e.target)) {
    document.getElementById('sessionTokensDetail').classList.remove('visible');
  }
});

// ===================== Status & Config =====================

async function checkStatus() {
  const dot = document.getElementById('statusDot');
  const text = document.getElementById('statusText');
  const banner = document.getElementById('setupBanner');

  try {
    const res = await fetch(`${API_BASE}/api/status`);
    appState = await res.json();

    if (appState.has_api) {
      dot.className = 'status-dot connected';
      text.textContent = `Connected (${appState.key_preview})`;
      banner.style.display = 'none';
      updateSettingsModal(true);
    } else {
      dot.className = 'status-dot disconnected';
      text.textContent = 'No API Key';
      banner.style.display = 'block';
      updateSettingsModal(false);
    }
    document.getElementById('modelDisplay').textContent = appState.model;
    const dbIndicator = document.getElementById('testDbIndicator');
    if (dbIndicator) {
      if (appState.has_test_db) {
        dbIndicator.style.display = 'inline';
        dbIndicator.innerHTML = '<span class="status-dot connected" style="margin-right:4px;"></span>Test DB';
      } else {
        dbIndicator.style.display = 'none';
      }
    }
  } catch {
    dot.className = 'status-dot disconnected';
    text.textContent = 'Server not running';
    banner.style.display = 'none';
  }
}

function updateSettingsModal(hasKey) {
  const display = document.getElementById('currentKeyDisplay');
  const form = document.getElementById('settingsKeyForm');
  const preview = document.getElementById('currentKeyPreview');

  if (hasKey) {
    display.style.display = 'flex';
    form.style.display = 'none';
    preview.textContent = appState.key_preview;
  } else {
    display.style.display = 'none';
    form.style.display = 'block';
  }
}

// ===================== API Key Management =====================

async function saveKey(inputId, statusId, btnId) {
  const input = document.getElementById(inputId);
  const status = document.getElementById(statusId);
  const btn = document.getElementById(btnId);
  const key = input.value.trim();

  if (!key) {
    status.className = 'key-status error';
    status.textContent = 'Please enter an API key.';
    return;
  }
  if (!key.startsWith('sk-ant-')) {
    status.className = 'key-status error';
    status.textContent = 'Key should start with sk-ant-';
    return;
  }

  btn.disabled = true;
  btn.textContent = 'Validating...';
  status.className = 'key-status';
  status.textContent = 'Checking key with Anthropic...';

  try {
    const res = await fetch(`${API_BASE}/api/save-key`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ key })
    });
    const data = await res.json();

    if (data.status === 'ok') {
      status.className = 'key-status success';
      status.textContent = 'API key saved and verified!';
      input.value = '';
      await checkStatus();
      setTimeout(() => { status.textContent = ''; }, 3000);
    } else {
      status.className = 'key-status error';
      status.textContent = data.error || 'Failed to save key.';
    }
  } catch (err) {
    status.className = 'key-status error';
    status.textContent = 'Could not reach the server.';
  }

  btn.disabled = false;
  btn.textContent = inputId.includes('setup') ? 'Connect' : 'Save';
}

function saveKeyFromSetup() { saveKey('setupKeyInput', 'setupKeyStatus', 'setupSaveBtn'); }
function saveKeyFromSettings() { saveKey('settingsKeyInput', 'settingsKeyStatus', 'settingsSaveBtn'); }

async function removeKey() {
  try {
    await fetch(`${API_BASE}/api/remove-key`, { method: 'POST',
      headers: { 'Content-Type': 'application/json' }, body: '{}' });
    await checkStatus();
    closeSettings();
  } catch {}
}

// ===================== Settings Modal =====================

function openSettings() {
  document.getElementById('settingsModal').classList.add('active');
}
function closeSettings() {
  document.getElementById('settingsModal').classList.remove('active');
}
document.getElementById('settingsModal').addEventListener('click', (e) => {
  if (e.target === e.currentTarget) closeSettings();
});

// ===================== Sidebar Toggle =====================

function toggleSidebar() {
  const sidebar = document.getElementById('sidebar');
  const icon = document.getElementById('sidebarToggleIcon');
  const collapsed = sidebar.classList.toggle('collapsed');
  icon.innerHTML = collapsed ? '&#9654;' : '&#9664;';
}

// ===================== Chat UI =====================

function autoResize(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 120) + 'px';
}

function askExample(btn) {
  document.getElementById('questionInput').value = btn.textContent;
  autoResize(document.getElementById('questionInput'));
  sendQuestion();
}

function addMessage(role, content) {
  const welcome = document.getElementById('welcome');
  if (welcome) welcome.style.display = 'none';

  const messages = document.getElementById('messages');
  const div = document.createElement('div');
  div.className = `message ${role}`;
  div.innerHTML = `
    <div class="label">${role === 'user' ? 'You' : 'Results'}</div>
    <div class="content">${content}</div>
  `;
  messages.appendChild(div);
  messages.scrollTop = messages.scrollHeight;
  return div;
}

function addLoading(text) {
  const messages = document.getElementById('messages');
  const div = document.createElement('div');
  div.className = 'message assistant';
  div.id = 'loading-msg';
  div.innerHTML = `
    <div class="label">Results</div>
    <div class="content">
      <div class="loading"><span></span><span></span><span></span></div>
      ${text || 'Generating query...'}
    </div>
  `;
  messages.appendChild(div);
  messages.scrollTop = messages.scrollHeight;
}

function updateLoading(text) {
  const el = document.getElementById('loading-msg');
  if (el) {
    const content = el.querySelector('.content');
    content.innerHTML = `
      <div class="loading"><span></span><span></span><span></span></div>
      ${text}
    `;
  }
}

function removeLoading() {
  const el = document.getElementById('loading-msg');
  if (el) el.remove();
}

// ===================== SQL Formatting =====================

function highlightSQL(sql) {
  const keywords = ['SELECT', 'FROM', 'WHERE', 'JOIN', 'LEFT JOIN', 'RIGHT JOIN',
    'INNER JOIN', 'ON', 'AND', 'OR', 'NOT', 'IN', 'IS', 'NULL', 'AS', 'GROUP BY',
    'ORDER BY', 'HAVING', 'UNION', 'ALL', 'DISTINCT', 'CASE', 'WHEN', 'THEN',
    'ELSE', 'END', 'EXISTS', 'BETWEEN', 'LIKE', 'DESC', 'ASC', 'FETCH', 'FIRST',
    'ROWS', 'ONLY', 'WITH', 'INSERT', 'INTO', 'VALUES', 'UPDATE', 'SET', 'DELETE',
    'CREATE', 'TABLE', 'INDEX', 'VIEW', 'OUTER'];
  const funcs = ['SUM', 'COUNT', 'AVG', 'MAX', 'MIN', 'NVL', 'UPPER', 'LOWER',
    'TRUNC', 'TO_CHAR', 'TO_DATE', 'TO_NUMBER', 'ROUND', 'COALESCE', 'DECODE',
    'ADD_MONTHS', 'SYSDATE', 'MONTHS_BETWEEN', 'SUBSTR', 'INSTR', 'REPLACE',
    'TRIM', 'LPAD', 'RPAD', 'LENGTH', 'FLOOR', 'CEIL', 'ABS', 'GREATEST', 'LEAST',
    'LISTAGG', 'ROW_NUMBER', 'RANK', 'DENSE_RANK', 'OVER', 'PARTITION BY'];

  let r = sql.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
  r = r.replace(/(--.*$)/gm, '<span class="cm">$1</span>');
  r = r.replace(/('(?:[^']|'')*')/g, '<span class="str">$1</span>');
  r = r.replace(/\b(\d+\.?\d*)\b/g, '<span class="num">$1</span>');
  const funcRe = new RegExp('\\b(' + funcs.join('|') + ')\\b(?=\\s*\\()', 'gi');
  r = r.replace(funcRe, (m) => `<span class="fn">${m}</span>`);
  const kwRe = new RegExp('\\b(' + keywords.join('|') + ')\\b', 'gi');
  r = r.replace(kwRe, (m) => `<span class="kw">${m.toUpperCase()}</span>`);
  return r;
}

// Extract the first runnable SQL block from Claude's response
function extractMainSQL(text) {
  const blocks = [];
  const re = /```sql\s*([\s\S]*?)\s*```/g;
  let match;
  while ((match = re.exec(text)) !== null) {
    const sql = match[1].trim();
    // Only real queries, not comment-only snippets
    if (/\b(SELECT|WITH)\b/i.test(sql)) {
      blocks.push(sql);
    }
  }
  return blocks.length > 0 ? blocks[0] : null;
}

// Lightweight markdown-to-HTML renderer for LLM explanation text
function renderMarkdown(text) {
  let html = text
    .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');

  // Split into lines for block-level processing
  const lines = html.split('\n');
  const result = [];
  let inList = false;
  let listType = null; // 'ul' or 'ol'

  for (let i = 0; i < lines.length; i++) {
    let line = lines[i];

    // Headers: ### heading → <h4>, ## → <h3> (shift down since these are inside detail sections)
    const h3Match = line.match(/^###\s+(.+)/);
    if (h3Match) {
      if (inList) { result.push(`</${listType}>`); inList = false; }
      result.push(`<strong style="display:block;margin:10px 0 4px">${h3Match[1]}</strong>`);
      continue;
    }
    const h2Match = line.match(/^##\s+(.+)/);
    if (h2Match) {
      if (inList) { result.push(`</${listType}>`); inList = false; }
      result.push(`<strong style="display:block;margin:12px 0 6px;font-size:1.05em">${h2Match[1]}</strong>`);
      continue;
    }

    // Unordered list: - item or * item
    const ulMatch = line.match(/^[\s]*[-*]\s+(.+)/);
    if (ulMatch) {
      if (!inList || listType !== 'ul') {
        if (inList) result.push(`</${listType}>`);
        result.push('<ul style="margin:4px 0 4px 20px;padding:0">');
        inList = true; listType = 'ul';
      }
      result.push(`<li>${applyInline(ulMatch[1])}</li>`);
      continue;
    }

    // Ordered list: 1. item
    const olMatch = line.match(/^[\s]*(\d+)\.\s+(.+)/);
    if (olMatch) {
      if (!inList || listType !== 'ol') {
        if (inList) result.push(`</${listType}>`);
        result.push('<ol style="margin:4px 0 4px 20px;padding:0">');
        inList = true; listType = 'ol';
      }
      result.push(`<li>${applyInline(olMatch[2])}</li>`);
      continue;
    }

    // Close any open list
    if (inList && line.trim() === '') {
      result.push(`</${listType}>`);
      inList = false;
    }

    // Regular paragraph
    if (line.trim()) {
      result.push(`<p style="margin:6px 0">${applyInline(line)}</p>`);
    }
  }

  if (inList) result.push(`</${listType}>`);
  return result.join('\n');
}

// Apply inline markdown: **bold**, *italic*, `code`, [link](url)
function applyInline(text) {
  return text
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*(.+?)\*/g, '<em>$1</em>')
    .replace(/`([^`]+)`/g, '<code style="background:rgba(255,255,255,0.08);padding:1px 5px;border-radius:3px;font-size:0.9em">$1</code>');
}

// Build the hidden SQL detail section from the full response
function buildSQLDetail(text, sqliteInfo, usage) {
  const parts = text.split(/(```sql[\s\S]*?```)/g);
  let html = '';
  let sqlCount = 0;

  for (const part of parts) {
    const sqlMatch = part.match(/```sql\s*([\s\S]*?)\s*```/);
    if (sqlMatch) {
      sqlCount++;
      const sqlCode = sqlMatch[1].trim();
      const sqlId = `sql-detail-${Date.now()}-${sqlCount}`;
      html += `
        <div class="sql-block">
          <div class="sql-header">
            <span>SAP SQL</span>
            <button class="copy-btn" onclick="copySQL('${sqlId}', this)">Copy</button>
          </div>
          <div class="sql-code" id="${sqlId}">${highlightSQL(sqlCode)}</div>
        </div>`;
    } else if (part.trim()) {
      html += `<div class="explanation">${renderMarkdown(part)}</div>`;
    }
  }

  // Append SQLite translation if available
  if (sqliteInfo) {
    html += `<details class="sqlite-detail"><summary>SQLite translation used</summary><pre>${sqliteInfo.replace(/&/g,'&amp;').replace(/</g,'&lt;')}</pre></details>`;
  }

  // Append token usage if available
  if (usage) {
    const total = (usage.input_tokens || 0) + (usage.output_tokens || 0);
    const queryCost = calcTokenCost(usage.input_tokens || 0, usage.output_tokens || 0);
    html += `<div class="token-usage">` +
      `<span class="token-label">Tokens:</span> ` +
      `<span class="token-value">${(usage.input_tokens || 0).toLocaleString()} input</span>` +
      ` &middot; ` +
      `<span class="token-value">${(usage.output_tokens || 0).toLocaleString()} output</span>` +
      ` &middot; ` +
      `<span class="token-value">${total.toLocaleString()} total</span>` +
      ` &middot; ` +
      `<span class="token-value">${formatCost(queryCost)}</span>` +
      `</div>`;
  }

  return html;
}

// Format a cell value based on actual column data type from the backend.
// "float" columns are currency amounts → $1,234.56
// Column formatting: three numeric display types
//   "currency" — monetary values → $1,234.56
//   "number"   — non-monetary numeric (counts, quantities) → 1,234 or 1,234.56
//   "str"      — text, dates → as-is
//
// Strong currency tokens: words that reliably indicate money
const CURRENCY_TOKENS = new Set(['amount','balance','cash','surplus','shortfall','spend','expense','revenue','cost','price','credit','debit','receivable','payable','value','salary','wage','wages','compensation','earnings','premium']);
// Weak currency tokens: only indicate money when NOT combined with a non-currency token
const WEAK_CURRENCY_TOKENS = new Set(['total','paid','outstanding','overdue','remaining','payment']);
// Non-currency tokens: words that indicate counts, IDs, quantities, etc.
const NON_CURRENCY_TOKENS = new Set(['number','num','line','id','code','flag','status','date','name','count','qty','quantity','percent','pct','ratio','rate','org','seq','rank','row','period','type','class','category','method','description','vendor','customer','supplier','order','header','ordered','shipped','billed','received','cancelled','approved','lines','orders','items','records','transactions','days','months','years','pending','open','closed']);
function colTokens(name) { return name.toLowerCase().split(/[_\s]+/); }
function detectColFormat(name) {
  const tokens = colTokens(name);
  const hasStrong = tokens.some(t => CURRENCY_TOKENS.has(t));
  if (hasStrong) return 'currency';
  const hasWeak = tokens.some(t => WEAK_CURRENCY_TOKENS.has(t));
  const hasNon  = tokens.some(t => NON_CURRENCY_TOKENS.has(t));
  if (hasWeak && !hasNon) return 'currency';
  return 'none'; // no currency signal
}

function formatCellValue(val, colType) {
  if (val === null) return '<span style="color:#5c6370">NULL</span>';

  if (colType === 'currency') {
    let num = typeof val === 'number' ? val : parseFloat(val);
    if (!isNaN(num)) {
      const formatted = num.toLocaleString('en-US', {
        style: 'currency', currency: 'USD',
        minimumFractionDigits: 2, maximumFractionDigits: 2
      });
      return `<span class="cell-currency">${formatted}</span>`;
    }
  }

  if (colType === 'number') {
    let num = typeof val === 'number' ? val : parseFloat(val);
    if (!isNaN(num)) {
      // Plain number with commas, no $ sign; use decimals only if present
      const hasDecimals = num !== Math.floor(num);
      const formatted = num.toLocaleString('en-US', {
        minimumFractionDigits: hasDecimals ? 2 : 0,
        maximumFractionDigits: hasDecimals ? 2 : 0
      });
      return formatted;
    }
  }

  // Everything else (int, str) displayed as-is
  return String(val).replace(/&/g,'&amp;').replace(/</g,'&lt;');
}

function buildResultsTable(data) {
  if (data.status === 'ok' && data.columns && data.columns.length > 0 && data.row_count > 0) {
    const colTypes = data.column_types || data.columns.map(() => 'str');

    // Classify numeric columns as 'currency' or 'number' based on column name
    for (let ci = 0; ci < data.columns.length; ci++) {
      const colName = data.columns[ci];
      const nameSignal = detectColFormat(colName);

      if (colTypes[ci] === 'float' || colTypes[ci] === 'int') {
        if (nameSignal === 'currency') {
          colTypes[ci] = 'currency';
        } else if (colTypes[ci] === 'float') {
          // Float without currency name → plain formatted number
          colTypes[ci] = 'number';
        }
        // int without currency name stays as-is (displayed raw)
      } else if (nameSignal === 'currency') {
        // String column with currency name — check if values are numeric
        const hasNumeric = data.rows.some(row => {
          const v = row[ci];
          return v !== null && (typeof v === 'number' || (typeof v === 'string' && !isNaN(parseFloat(v)) && /^[\d\s,.\-+$]+$/.test(v.trim())));
        });
        if (hasNumeric) colTypes[ci] = 'currency';
      }
    }

    let h = '<div class="results-container">';
    h += `<div class="results-header"><span>Query Results</span><span class="row-count">${data.row_count} row${data.row_count !== 1 ? 's' : ''}${data.has_more ? '+' : ''}</span></div>`;
    h += '<div class="results-table-wrap"><table class="results-table"><thead><tr>';
    for (let ci = 0; ci < data.columns.length; ci++) {
      const isNumeric = ['currency','number','float','int'].includes(colTypes[ci]);
      const align = isNumeric ? ' style="text-align:right"' : '';
      h += `<th${align}>${data.columns[ci]}</th>`;
    }
    h += '</tr></thead><tbody>';
    for (const row of data.rows) {
      h += '<tr>';
      for (let ci = 0; ci < row.length; ci++) {
        const isNumeric = ['currency','number','float','int'].includes(colTypes[ci]);
        const align = isNumeric ? ' style="text-align:right"' : '';
        h += `<td${align}>${formatCellValue(row[ci], colTypes[ci])}</td>`;
      }
      h += '</tr>';
    }
    h += '</tbody></table></div></div>';
    return h;
  } else if (data.status === 'ok') {
    return '<div class="results-container"><div class="results-none">Query executed successfully but returned no rows.</div></div>';
  } else {
    let h = '<div class="results-container"><div class="results-error">';
    h += `Error running query: ${(data.error || 'Unknown error').replace(/&/g,'&amp;').replace(/</g,'&lt;')}`;
    h += '</div></div>';
    return h;
  }
}

function toggleSQLDetail(id) {
  const el = document.getElementById(id);
  const btn = document.querySelector(`[data-toggle="${id}"]`);
  if (el.classList.contains('visible')) {
    el.classList.remove('visible');
    btn.classList.remove('open');
  } else {
    el.classList.add('visible');
    btn.classList.add('open');
  }
}

function copySQL(id, btn) {
  const el = document.getElementById(id);
  navigator.clipboard.writeText(el.textContent).then(() => {
    btn.textContent = 'Copied!';
    btn.classList.add('copied');
    setTimeout(() => { btn.textContent = 'Copy'; btn.classList.remove('copied'); }, 2000);
  });
}

// ===================== Send Question =====================

async function sendQuestion() {
  if (isGenerating) return;
  const input = document.getElementById('questionInput');
  const question = input.value.trim();
  if (!question) return;

  input.value = '';
  autoResize(input);
  isGenerating = true;
  document.getElementById('sendBtn').disabled = true;

  addMessage('user', question.replace(/</g, '&lt;').replace(/>/g, '&gt;'));
  addLoading(conversationHistory.length > 0 ? 'Processing your response...' : 'Generating query...');

  try {
    // Step 1: Generate SQL (include conversation history for follow-ups)
    const res = await fetch(`${API_BASE}/api/generate`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ question, history: conversationHistory })
    });
    const data = await res.json();

    if (data.status === 'ok') {
      const fullResponse = data.result;
      updateSessionTokens(data.usage);
      const mainSQL = extractMainSQL(fullResponse);

      if (mainSQL && appState.has_test_db) {
        // Got SQL — run the query
        updateLoading('Running query on test database...');

        const execRes = await fetch(`${API_BASE}/api/execute`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sql: mainSQL })
        });
        const execData = await execRes.json();

        removeLoading();

        // Build the response: results first, then hidden SQL detail
        const detailId = `detail-${Date.now()}`;
        const resultsHtml = buildResultsTable(execData);
        const sqlDetailHtml = buildSQLDetail(fullResponse, execData.sqlite_sql || null, data.usage);

        const msgDiv = addMessage('assistant', '');
        msgDiv.querySelector('.content').innerHTML =
          resultsHtml +
          `<button class="sql-toggle" data-toggle="${detailId}" onclick="toggleSQLDetail('${detailId}')">` +
            `<span class="arrow">&#9654;</span> Show SQL &amp; details` +
          `</button>` +
          `<div class="sql-detail" id="${detailId}">${sqlDetailHtml}</div>`;

        // SQL was generated and executed — conversation is complete, reset history
        conversationHistory = [];

      } else if (!mainSQL) {
        // No SQL found — this is a clarification question from the LLM
        removeLoading();

        // Format the response as a conversational message with markdown
        addMessage('assistant', renderMarkdown(fullResponse));

        // Save conversation history so the user's follow-up has context
        conversationHistory.push({ role: 'user', content: question });
        conversationHistory.push({ role: 'assistant', content: fullResponse });

      } else if (mainSQL && !appState.has_test_db) {
        // Has SQL but no test DB — show SQL detail without execution
        removeLoading();
        const detailId = `detail-${Date.now()}`;
        const sqlDetailHtml = buildSQLDetail(fullResponse, null, data.usage);

        const msgDiv = addMessage('assistant', '');
        msgDiv.querySelector('.content').innerHTML = sqlDetailHtml;
        conversationHistory = [];
      }
    } else {
      removeLoading();
      addMessage('assistant',
        `<span style="color:var(--red)">Error:</span> ${data.error || 'Unknown error'}` +
        (data.error && data.error.includes('API key') ?
          '<br><br>Click the &#9881; icon in the header to configure your API key.' : ''));
    }
  } catch (err) {
    removeLoading();
    addMessage('assistant',
      'Could not reach the server. Make sure the engine is running.');
  }

  isGenerating = false;
  document.getElementById('sendBtn').disabled = false;
  input.focus();
}

// ===================== Init =====================
checkStatus();
</script>
</body>
</html>
